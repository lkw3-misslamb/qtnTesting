import React, { useState, useMemo } from 'react';
import { Database, ArrowRightLeft, ArrowLeft, ArrowRight, XCircle, FileText, Grid, Info } from 'lucide-react';

// 模擬數據
const TABLE_A = [
  { id: 1, name: '小明 (Ming)', role: 'Admin' },
  { id: 2, name: '小華 (Hua)', role: 'User' },
  { id: 3, name: '大壯 (John)', role: 'User' },
  { id: 4, name: '美美 (May)', role: 'Guest' },
];

const TABLE_B = [
  { order_id: 101, amount: 500, user_id: 2 },
  { order_id: 102, amount: 1200, user_id: 1 },
  { order_id: 103, amount: 300, user_id: 2 },
  { order_id: 104, amount: 999, user_id: 5 }, // ID 5 不在 Table A 中
];

const MODES = {
  INNER: 'INNER JOIN',
  LEFT: 'LEFT JOIN',
  RIGHT: 'RIGHT JOIN',
  FULL: 'FULL OUTER JOIN',
  IMPLICIT: 'IMPLICIT JOIN (WHERE)',
  CROSS: 'CROSS JOIN',
};

const SQLJoinVisualizer = () => {
  const [mode, setMode] = useState(MODES.INNER);

  // 根據模式計算結果邏輯
  const resultData = useMemo(() => {
    let results = [];

    switch (mode) {
      case MODES.INNER:
      case MODES.IMPLICIT: // Implicit Join 的結果與 Inner Join 相同
        // A 和 B 的交集
        TABLE_A.forEach(rowA => {
          const matches = TABLE_B.filter(rowB => rowB.user_id === rowA.id);
          matches.forEach(rowB => {
            results.push({ ...rowA, ...rowB, key: `${rowA.id}-${rowB.order_id}`, _source: 'both' });
          });
        });
        break;

      case MODES.LEFT:
        // A 的全部 + B 的匹配 (無匹配則 NULL)
        TABLE_A.forEach(rowA => {
          const matches = TABLE_B.filter(rowB => rowB.user_id === rowA.id);
          if (matches.length > 0) {
            matches.forEach(rowB => {
              results.push({ ...rowA, ...rowB, key: `${rowA.id}-${rowB.order_id}`, _source: 'both' });
            });
          } else {
            results.push({ ...rowA, order_id: null, amount: null, user_id: null, key: `${rowA.id}-null`, _source: 'left' });
          }
        });
        break;

      case MODES.RIGHT:
        // B 的全部 + A 的匹配 (無匹配則 NULL)
        TABLE_B.forEach(rowB => {
          const matchA = TABLE_A.find(rowA => rowA.id === rowB.user_id);
          if (matchA) {
            results.push({ ...matchA, ...rowB, key: `${matchA.id}-${rowB.order_id}`, _source: 'both' });
          } else {
            results.push({ id: null, name: null, role: null, ...rowB, key: `null-${rowB.order_id}`, _source: 'right' });
          }
        });
        break;

      case MODES.FULL:
        // A 的全部 + B 的全部 (互補 NULL)
        // 1. 先做 Left Join
        TABLE_A.forEach(rowA => {
          const matches = TABLE_B.filter(rowB => rowB.user_id === rowA.id);
          if (matches.length > 0) {
            matches.forEach(rowB => {
              results.push({ ...rowA, ...rowB, key: `${rowA.id}-${rowB.order_id}`, _source: 'both' });
            });
          } else {
            results.push({ ...rowA, order_id: null, amount: null, user_id: null, key: `${rowA.id}-null`, _source: 'left' });
          }
        });
        // 2. 找 B 中沒被匹配到的
        TABLE_B.forEach(rowB => {
          const matchA = TABLE_A.find(rowA => rowA.id === rowB.user_id);
          if (!matchA) {
            results.push({ id: null, name: null, role: null, ...rowB, key: `null-${rowB.order_id}`, _source: 'right' });
          }
        });
        break;

      case MODES.CROSS:
        // 笛卡爾積：每一行 A 配對每一行 B
        TABLE_A.forEach(rowA => {
            TABLE_B.forEach(rowB => {
                results.push({ ...rowA, ...rowB, key: `${rowA.id}-${rowB.order_id}-cross`, _source: 'both' });
            });
        });
        break;

      default:
        break;
    }
    return results;
  }, [mode]);

  // 生成 SVG 線條配置
  const connections = useMemo(() => {
    const lines = [];
    const rowHeight = 40;
    const headerOffset = 40;

    TABLE_A.forEach((rowA, indexA) => {
      const yA = headerOffset + indexA * rowHeight + rowHeight / 2;
      
      TABLE_B.forEach((rowB, indexB) => {
        const yB = headerOffset + indexB * rowHeight + rowHeight / 2;
        
        if (mode === MODES.CROSS) {
            // Cross Join: 連接所有線
            lines.push({
                id: `cross-${rowA.id}-${rowB.order_id}`,
                y1: yA,
                y2: yB,
                matched: true,
                type: 'cross'
            });
        } else {
            // 其他 Join: 只連接匹配的
            if (rowA.id === rowB.user_id) {
                lines.push({
                    id: `conn-${rowA.id}-${rowB.order_id}`,
                    y1: yA,
                    y2: yB,
                    matched: true,
                    type: 'match'
                });
            }
        }
      });
    });

    return lines;
  }, [mode]);

  // 生成 SQL 顯示字串
  const sqlQuery = useMemo(() => {
    switch (mode) {
      case MODES.INNER:
        return `SELECT * \nFROM Users A \nINNER JOIN Orders B \nON A.id = B.user_id;`;
      case MODES.LEFT:
        return `SELECT * \nFROM Users A \nLEFT JOIN Orders B \nON A.id = B.user_id;`;
      case MODES.RIGHT:
        return `SELECT * \nFROM Users A \nRIGHT JOIN Orders B \nON A.id = B.user_id;`;
      case MODES.FULL:
        return `SELECT * \nFROM Users A \nFULL OUTER JOIN Orders B \nON A.id = B.user_id;`;
      case MODES.IMPLICIT:
        return `SELECT * \nFROM Users A, Orders B \nWHERE A.id = B.user_id;`;
      case MODES.CROSS:
        return `SELECT * \nFROM Users A \nCROSS JOIN Orders B;`;
      default:
        return '';
    }
  }, [mode]);

  // 判斷某一行是否應該高亮或半透明 (Visual State)
  const getRowStyle = (tableType, row) => {
    // Cross Join 全部參與
    if (mode === MODES.CROSS) {
        return tableType === 'A' ? 'bg-purple-50 border-l-4 border-purple-300' : 'bg-purple-50 border-r-4 border-purple-300';
    }

    let isParticipating = false;
    
    // 計算是否參與 Join
    if (tableType === 'A') {
        const hasMatch = TABLE_B.some(b => b.user_id === row.id);
        if ((mode === MODES.INNER || mode === MODES.IMPLICIT) && hasMatch) isParticipating = true;
        if (mode === MODES.LEFT) isParticipating = true; 
        if (mode === MODES.RIGHT && hasMatch) isParticipating = true;
        if (mode === MODES.FULL) isParticipating = true;
    } else {
        const hasMatch = TABLE_A.some(a => a.id === row.user_id);
        if ((mode === MODES.INNER || mode === MODES.IMPLICIT) && hasMatch) isParticipating = true;
        if (mode === MODES.LEFT && hasMatch) isParticipating = true;
        if (mode === MODES.RIGHT) isParticipating = true; 
        if (mode === MODES.FULL) isParticipating = true;
    }

    if (!isParticipating) return 'opacity-40 grayscale';
    
    // 顏色標記
    if (tableType === 'A') {
         const hasMatch = TABLE_B.some(b => b.user_id === row.id);
         if (!hasMatch && (mode === MODES.LEFT || mode === MODES.FULL)) return 'bg-yellow-50 border-l-4 border-yellow-400';
         return 'bg-green-50 border-l-4 border-green-500';
    } else {
         const hasMatch = TABLE_A.some(a => a.id === row.user_id);
         if (!hasMatch && (mode === MODES.RIGHT || mode === MODES.FULL)) return 'bg-yellow-50 border-r-4 border-yellow-400';
         return 'bg-blue-50 border-r-4 border-blue-500';
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
      <div className="max-w-6xl mx-auto space-y-6">
        
        {/* Header */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-200 pb-4">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2 text-indigo-700">
              <Database className="w-6 h-6" />
              SQL Join 可視化教學
            </h1>
            <p className="text-slate-500 text-sm mt-1">互動式學習 SQL 表格連接原理</p>
          </div>
          
          {/* Controls */}
          <div className="flex flex-wrap gap-2 mt-4 md:mt-0">
             {[
               { m: MODES.INNER, label: 'Inner Join', icon: ArrowRightLeft },
               { m: MODES.IMPLICIT, label: 'Implicit (Where)', icon: FileText },
               { m: MODES.LEFT, label: 'Left Join', icon: ArrowLeft },
               { m: MODES.RIGHT, label: 'Right Join', icon: ArrowRight },
               { m: MODES.FULL, label: 'Full Join', icon: XCircle },
               { m: MODES.CROSS, label: 'Cross Join', icon: Grid },
             ].map((btn) => (
               <button
                 key={btn.m}
                 onClick={() => setMode(btn.m)}
                 className={`px-3 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2
                   ${mode === btn.m 
                     ? 'bg-indigo-600 text-white shadow-md scale-105' 
                     : 'bg-white text-slate-600 hover:bg-indigo-50 border border-slate-200'}`}
               >
                 <btn.icon className="w-4 h-4" />
                 {btn.label}
               </button>
             ))}
          </div>
        </header>

        {/* Visualization Area */}
        <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6 overflow-hidden relative">
          
          <div className="flex justify-between mb-2 px-4">
            <div className="font-bold text-slate-700 w-1/3 text-center">Table A: Users (用戶表)</div>
            <div className="font-bold text-slate-700 w-1/3 text-center"></div>
            <div className="font-bold text-slate-700 w-1/3 text-center">Table B: Orders (訂單表)</div>
          </div>

          <div className="flex justify-between relative" style={{ minHeight: '220px' }}>
            
            {/* Table A */}
            <div className="w-1/3 z-10 space-y-0">
               <div className="bg-slate-100 border border-slate-300 p-2 font-mono text-xs text-slate-500 flex font-bold rounded-t-lg">
                 <span className="w-8">ID</span>
                 <span className="flex-1">Name</span>
               </div>
               {TABLE_A.map((row, idx) => (
                 <div 
                   key={row.id} 
                   className={`h-10 flex items-center px-2 text-sm border-b border-x border-slate-200 transition-all duration-300 ${getRowStyle('A', row)}`}
                   style={{ height: '40px' }}
                 >
                   <span className="w-8 font-mono font-bold">{row.id}</span>
                   <span className="truncate">{row.name}</span>
                 </div>
               ))}
               <div className="bg-slate-50 p-2 text-xs text-center text-slate-400 border border-slate-200 border-t-0 rounded-b-lg">
                  (共 4 筆)
               </div>
            </div>

            {/* SVG Connector Layer */}
            <div className="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
               <svg className="w-full h-full">
                 <defs>
                   <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                     <path d="M0,0 L0,6 L9,3 z" fill="#6366f1" />
                   </marker>
                 </defs>

                 {/* Join Lines */}
                 {connections.map((conn, i) => (
                   <path
                     key={conn.id}
                     d={`M 33% ${conn.y1} C 45% ${conn.y1}, 55% ${conn.y2}, 67% ${conn.y2}`}
                     fill="none"
                     stroke={
                        mode === MODES.CROSS 
                        ? '#d8b4fe' 
                        : (mode === MODES.RIGHT ? '#3b82f6' : '#22c55e')
                     } 
                     strokeWidth={mode === MODES.CROSS ? "1" : "3"}
                     strokeOpacity={mode === MODES.CROSS ? "0.3" : "0.6"}
                     className="transition-all duration-500"
                   />
                 ))}
                 
               </svg>
            </div>

            {/* Table B */}
            <div className="w-1/3 z-10 flex flex-col items-end">
               <div className="w-full">
                <div className="bg-slate-100 border border-slate-300 p-2 font-mono text-xs text-slate-500 flex font-bold rounded-t-lg">
                    <span className="w-12">OrdID</span>
                    <span className="w-12 text-center">UsrID</span>
                    <span className="flex-1 text-right">Amt</span>
                </div>
                {TABLE_B.map((row, idx) => (
                    <div 
                    key={row.order_id} 
                    className={`h-10 flex items-center px-2 text-sm border-b border-x border-slate-200 transition-all duration-300 ${getRowStyle('B', row)}`}
                    style={{ height: '40px' }}
                    >
                    <span className="w-12 font-mono">{row.order_id}</span>
                    <span className="w-12 text-center font-bold font-mono bg-slate-100 rounded">{row.user_id}</span>
                    <span className="flex-1 text-right">${row.amount}</span>
                    </div>
                ))}
                 <div className="bg-slate-50 p-2 text-xs text-center text-slate-400 border border-slate-200 border-t-0 rounded-b-lg">
                  (共 4 筆)
               </div>
               </div>
            </div>

          </div>
          
          {/* Legend / Tip */}
          <div className="mt-4 flex gap-4 text-xs text-slate-500 justify-center bg-slate-50 p-2 rounded-lg border border-slate-100">
             {mode === MODES.CROSS ? (
                 <div className="flex items-center gap-1">
                    <span className="w-3 h-3 bg-purple-100 border border-purple-400 block rounded"></span>
                    <span>笛卡爾積組合 (Cartesian Product)</span>
                 </div>
             ) : (
                <>
                    <div className="flex items-center gap-1">
                    <span className="w-3 h-3 bg-green-100 border border-green-500 block rounded"></span>
                    <span>匹配成功/保留 (Match)</span>
                    </div>
                    <div className="flex items-center gap-1">
                    <span className="w-3 h-3 bg-yellow-50 border border-yellow-400 block rounded"></span>
                    <span>無匹配但保留 (Null Padding)</span>
                    </div>
                    <div className="flex items-center gap-1">
                    <span className="w-3 h-3 opacity-40 grayscale bg-white border border-slate-300 block rounded"></span>
                    <span>被排除 (Excluded)</span>
                    </div>
                </>
             )}
          </div>
        </div>

        {/* Results & Code Section */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            {/* Result Table */}
            <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                    <span className="bg-indigo-100 text-indigo-700 p-1 rounded">3</span>
                    查詢結果 (Result Set)
                </h2>
                <div className="overflow-x-auto max-h-64 overflow-y-auto">
                    <table className="w-full text-sm text-left relative">
                        <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b sticky top-0 shadow-sm z-10">
                            <tr>
                                <th className="px-3 py-2 bg-slate-50">ID (A)</th>
                                <th className="px-3 py-2 bg-slate-50">Name</th>
                                <th className="px-3 py-2 border-l border-slate-200 bg-slate-50">OrdID (B)</th>
                                <th className="px-3 py-2 bg-slate-50">Amt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {resultData.length === 0 ? (
                                <tr><td colSpan="4" className="p-4 text-center text-slate-400">無結果</td></tr>
                            ) : (
                                resultData.map((row, i) => (
                                    <tr key={i} className="border-b hover:bg-slate-50 transition-colors">
                                        <td className="px-3 py-2 font-mono">
                                            {row.id === null ? <span className="text-red-400 italic">NULL</span> : row.id}
                                        </td>
                                        <td className="px-3 py-2">
                                            {row.name === null ? <span className="text-red-400 italic">NULL</span> : row.name}
                                        </td>
                                        <td className="px-3 py-2 border-l border-slate-200 font-mono">
                                            {row.order_id === null ? <span className="text-red-400 italic">NULL</span> : row.order_id}
                                        </td>
                                        <td className="px-3 py-2">
                                            {row.amount === null ? <span className="text-red-400 italic">NULL</span> : row.amount}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
                <div className="mt-2 text-xs text-right text-slate-400">
                    共 {resultData.length} 筆資料
                </div>
            </div>

            {/* SQL Code & Explanation */}
            <div className="flex flex-col gap-4">
                <div className="bg-slate-900 text-slate-200 rounded-xl p-6 shadow-lg font-mono text-sm relative overflow-hidden group">
                    <div className="absolute top-2 right-2 text-xs text-slate-500 font-sans uppercase tracking-wider">SQL Query</div>
                    <pre className="whitespace-pre-wrap z-10 relative">
                        {sqlQuery.split('\n').map((line, i) => (
                             <div key={i} className={line.includes('JOIN') || line.includes('WHERE') ? 'text-pink-400 font-bold' : ''}>{line}</div>
                        ))}
                    </pre>
                </div>

                <div className="bg-blue-50 border border-blue-100 rounded-xl p-6 flex-1">
                     <h3 className="font-bold text-blue-800 flex items-center gap-2 mb-2">
                        <Info className="w-4 h-4" />
                        這是什麼意思？
                     </h3>
                     <p className="text-sm text-blue-700 leading-relaxed">
                        {mode === MODES.INNER && "標準寫法。只返回兩個表中「ID」匹配的行。大壯(3)和美美(4)因為沒有訂單而被排除。"}
                        {mode === MODES.IMPLICIT && "隱式連接 (Implicit Join)。這是在 SQL-92 標準之前的老式寫法。它通過在 FROM 中列出兩個表，然後在 WHERE 中指定連接條件。如果不小心忘了 WHERE，就會變成災難性的 Cross Join。結果與 Inner Join 完全相同。"}
                        {mode === MODES.LEFT && "以左表 (Users) 為主。所有用戶都會顯示。如果有訂單，顯示訂單詳情；如果沒有訂單（如大壯），訂單欄位會填補 NULL。"}
                        {mode === MODES.RIGHT && "以右表 (Orders) 為主。所有訂單都會顯示。如果訂單找不到對應的用戶（如 Order 104），用戶欄位會填補 NULL。"}
                        {mode === MODES.FULL && "貪婪模式！保留兩邊所有的資料。不管有沒有匹配，所有用戶和所有訂單都會出現在結果中，缺少的資料全部用 NULL 填補。"}
                        {mode === MODES.CROSS && "笛卡爾積 (Cartesian Product)。這是將 Table A 的每一行與 Table B 的每一行強制配對。4 個用戶 x 4 筆訂單 = 16 筆結果。這通常發生在忘了寫 WHERE 條件的時候！"}
                     </p>
                </div>
            </div>

        </div>

      </div>
    </div>
  );
};

export default SQLJoinVisualizer;
